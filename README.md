# NgramIndex

## 仕様

下記2つの機能を有するアプリケーション

### インデックスファイル作成機能
　[郵便番号のCSV](http://www.post.japanpost.jp/zipcode/dl/kogaki/zip/ken_all.zip)をデータソースとし、住所レコードのインデックスファイルを作成する機能


### 検索機能

　入力として、文字列が与えられる。与えられた文字列中の文字をすべて含む住所レコードを上記で作成したインデックスを用いて検索し出力する機能。ただしスペースは文字として扱わない。
※データベースまた検索エンジン利用するのはNG

#### 例１:　入力: 渋谷

出力

"9870113","宮城県","遠田郡涌谷町","渋江"

"0101642","秋田県","秋田市","新屋渋谷町"

"6050874","京都府","京都市東山区","常盤町（東大路通渋谷上る、渋谷通東大路東入、渋谷通東大路東入２丁目、東大路五条下る）"
  ・・・・

注意:下記のような一つのレコードが複数行に分かれている箇所が存在する。これについては別のレコードとして処理してもよいが、結合できることが望ましい。

26105,"605  ","6050874","ｷﾖｳﾄﾌ","ｷﾖｳﾄｼﾋｶﾞｼﾔﾏｸ","ﾄｷﾜﾁﾖｳ","京都府","京都市東山区","常盤町（東大路通渋谷上る、渋谷通東大路東入、渋谷通東大路東入２丁目、",0,0,0,0,0,0

26105,"605  ","6050874","ｷﾖｳﾄﾌ","ｷﾖｳﾄｼﾋｶﾞｼﾔﾏｸ","ﾄｷﾜﾁﾖｳ","京都府","京都市東山区","東大路五条下る）",0,0,0,0,0,0

#### 例２：東京都

東京と京都が含まれている住所レコードが出力されること

---

## 実行説明資料

　コンソールアプリケーションとなっており、起動引数の指定によってインデックスの作成、検索の実行を行うことができます。

### インデックスの作成

　起動引数の指定がない場合はインデックスを作成します。

>NgramIndex

### 検索の実行

　検索を行うには、必ずインデックスの作成を行ってください。
　インデックスの作成が行ってなければ、検索処理は実行できません。

>NgramIndex {検索キーワード}


## 技術説明資料

### プロジェクト構成

+ NgramIndex.csproj			 …… 実行プログラム
+ NgramIndex.Tests.csproj	 …… テストプロジェクト
+ NgramIndex.Benchmarks.csproj	 …… ベンチマークプロジェクト

#### NgramIndex.csprojについて

　コードが肥大化していたため、クラスを分割しています。

　その上で、コンソールアプリケーションですが、Webやデスクトップアプリとしても使いまわせるように、検索のビジネスロジック部分を切り離しています。

### インデックスファイルの仕様について

インデックスファイルは大きくなりがちなので行数の値そのままではなく、間隔で保存しています。
京都を含む行が115,116,117,172だった場合は、

>"京都",115,1,1,55

となります。

これにより、45530KBから24241KBと半分に削減しています。（その後、無駄な行数のダブルクォートを削除して13108KB)

### 検索について

インデックスをすべて読み込んでから処理をしていましたが、処理が重かったので、インデックスを読み込むときに検索キーワードに必要な行だけを読み込んで処理しています。

これにより、


|検索|インデックスすべてを読み込む|インデックスを必要なだけ読み込む|
|----------------- |---------:|---------:|
|渋谷で検索したとき|2.388 s|1.314 s|
|東京都で検索したとき|3.367 s| 2.327 s|


#### インデックスをすべて読み込むとき

BenchmarkDotNet=v0.11.0, OS=Windows 10.0.17134.165 (1803/April2018Update/Redstone4)
Intel Core i7-7920HQ CPU 3.10GHz (Kaby Lake), 1 CPU, 2 logical and 2 physical cores
  [Host]     : .NET Framework 4.7.2 (CLR 4.0.30319.42000), 32bit LegacyJIT-v4.7.3131.0  [AttachedDebugger]
  DefaultJob : .NET Framework 4.7.2 (CLR 4.0.30319.42000), 32bit LegacyJIT-v4.7.3131.0


|           Method |     Mean |    Error |   StdDev |   Median |
|----------------- |---------:|---------:|---------:|---------:|
|      CreateIndex |  7.435 s | 0.1323 s | 0.1033 s |  7.410 s |
| SearchInputCase1 |  2.388 s | 0.0396 s | 0.0370 s |  2.385 s |
| SearchInputCase2 |  3.367 s | 0.0626 s | 0.0586 s |  3.350 s |
|        SearchAll | 13.931 s | 0.6597 s | 1.8170 s | 13.202 s |
|    SearchNoIndex |  1.659 s | 0.0091 s | 0.0085 s |  1.662 s |


#### インデックスを読み込むときに必要なデータだけを読み込む

BenchmarkDotNet=v0.11.0, OS=Windows 10.0.17134.165 (1803/April2018Update/Redstone4)
Intel Core i7-7920HQ CPU 3.10GHz (Kaby Lake), 1 CPU, 2 logical and 2 physical cores
  [Host]     : .NET Framework 4.7.2 (CLR 4.0.30319.42000), 32bit LegacyJIT-v4.7.3131.0  [AttachedDebugger]
  DefaultJob : .NET Framework 4.7.2 (CLR 4.0.30319.42000), 32bit LegacyJIT-v4.7.3131.0

|           Method |     Mean |    Error |   StdDev |
|----------------- |---------:|---------:|---------:|
|      CreateIndex |  7.445 s | 0.0857 s | 0.0669 s |
| SearchInputCase1 |  1.314 s | 0.0255 s | 0.0239 s |
| SearchInputCase2 |  2.327 s | 0.0420 s | 0.0393 s |
|        SearchAll | 11.220 s | 0.1634 s | 0.1365 s |
|    SearchNoIndex |  1.742 s | 0.0238 s | 0.0223 s |



### 使用ライブラリ

+ CsvHelper
+ Nunit
+ BenchmarkDotNet
